---
title: "Mass Shootings in the USA"
author: "Hannah Reitz & Sophie Hensgen"
date: "5/14/2020"
output: html_document
---

```{r}
library(openxlsx)
library(xml2)
library(rvest)
library(jsonlite)
library(robotstxt)
library(RSocrata)
library(dplyr)
library(rlist)
library(pipeR)
library(gtrendsR)
library(lubridate)

```
## Theory and Hypotheses

More dead people --> more media attention --> higher attention in Google trends

newworthiness in den Medien

1. The more people got injured, the longer the shooting stayed in the trends.

2. The more deaths, the longer the shooting stayed in the trends.

evtl. newswothiness in Kombination mit inequality

3. The more caucasians got shot or died during the shooting, the longer it stayed
in the trends.

4. Shootings in richer areas, stayed longer in the trends.


5. In states with looser gun control, shootings stayed longer in the trends


## Data from Wikipedia

Erlärung welche Daten, wie gescrapt, wie sehen die Daten aus Deskription


```{r}
url <- "https://en.wikipedia.org/wiki/List_of_mass_shootings_in_the_United_States"
t <- read_html(url)
table <- t %>% html_nodes("#mw-content-text > div > table") %>% html_table(trim=T)

table

```

hier Tabellen zusammensetzten

erstes klappt, danach gibt es ein problem mit incompatiblen types. 
Ich glaube wir müssen die buchstaben aus injured rausholen damit wir es in einen integer umändern können

To Do:

- gsub loop --> alle alle nicht zahlen rausziehen
- alle mutaten damit alle integer sein 
- wenn das gemacht alle joinen zu einer großen tabelle
- in excel Extra Variablen hinzufügen
- Datum in Zahlen ändern
- zwei neue variablen, eine zwei Tage vor dem Event und 14 Tage danach
- Description den Namen herausnehmen

```{r}

# Removing unnecessary expressions

for (i in 1:10) {
   table[[i]]$Injured <- gsub("[n 1]", "", table[[i]]$Injured, fixed = TRUE)
   table[[i]]$Injured <- gsub("[n 2]", "", table[[i]]$Injured, fixed = TRUE)
   table[[i]]$Injured <- gsub("[n 3]", "", table[[i]]$Injured, fixed = TRUE)
   table[[i]]$Injured <- gsub("[n 4]", "", table[[i]]$Injured, fixed = TRUE)
   table[[i]]$Injured <- gsub("[n 5]", "", table[[i]]$Injured, fixed = TRUE)
   table[[i]]$Injured <- gsub("[n 6]", "", table[[i]]$Injured, fixed = TRUE)
   table[[i]]$Injured <- gsub("[n 7]", "", table[[i]]$Injured, fixed = TRUE)
   table[[i]]$Injured <- gsub("[n 8]", "", table[[i]]$Injured, fixed = TRUE)
   table[[i]]$Injured <- gsub("[n 9]", "", table[[i]]$Injured, fixed = TRUE)
   table[[i]]$Injured <- gsub("+", "", table[[i]]$Injured, fixed = TRUE)
   table[[i]]$Dead <- gsub("[n 1]", "", table[[i]]$Dead, fixed = TRUE)
   table[[i]]$Dead <- gsub("[n 2]", "", table[[i]]$Dead, fixed = TRUE)
   table[[i]]$Dead <- gsub("[n 3]", "", table[[i]]$Dead, fixed = TRUE)
   table[[i]]$Dead <- gsub("[n 4]", "", table[[i]]$Dead, fixed = TRUE)
   table[[i]]$Dead <- gsub("[n 5]", "", table[[i]]$Dead, fixed = TRUE)
   table[[i]]$Dead <- gsub("[n 6]", "", table[[i]]$Dead, fixed = TRUE)
   table[[i]]$Dead <- gsub("[n 7]", "", table[[i]]$Dead, fixed = TRUE)
   table[[i]]$Dead <- gsub("[n 8]", "", table[[i]]$Dead, fixed = TRUE)
   table[[i]]$Dead <- gsub("[n 9]", "", table[[i]]$Dead, fixed = TRUE)
   table[[i]]$Dead <- gsub("+", "", table[[i]]$Dead, fixed = TRUE)
   table[[i]]$Total <- gsub("+", "", table[[i]]$Total, fixed = TRUE)
}


# Storing Injured, Dead and Total as numerics

for (i in 1:10) {
  as.numeric(as.character(table[[i]]$Injured))
  as.numeric(as.character(table[[i]]$Dead))
  as.numeric(as.character(table[[i]]$Total))
}


#####################################
# Date formatting not working
#dates <- table[[1]]$Date
#betterDates <- as.Date(dates,
#format = "%m %d %Y")

#table[[1]]

#for (i in 1:10) {
  #parse_date_time2("table[[i]]$Date", orders = "mdy")
  #as_date(table[[i]]$Date, tz = NULL, format = NULL)
  #as_date(table[[i]]$Date, origin = lubridate::origin)
  #c(as_date(table[[i]]$Date), as.Date(table[[i]]$Date))
#  date <- as.Date(table[[i]]$Date, format = "%B %d, %Y")
#}

#table[[1]]
####################################################

# Joining all tables to one data frame

newtab <- table[[1]]

for (i in 1:10) {
  newtab <- newtab %>% full_join(table[[i]], by = c("Date", "Location", "Dead", "Injured", "Total", "Description"))
}

newtab

# Works for simple dates, need to think about how we handle timespans --> at the moment converting them gives NAs

newtab[["Date"]] <- as.Date(newtab$Date, format = "%B %d, %Y")
newtab

#Deleting the useless part of description --> possibly need to remove year as nobody googles the year when event is happening

newtab$Description <- sub(":.*$", "", newtab$Description)
newtab
```

Wenn wir das geschafft haben sollten wir diesen Loop nutzen können
Zurzeit funktioniert er noch nicht
```{r}
new <- table[[1]]
for (i in 2:10){
  newtab <- newtab %>% full_join(table[[i]])
}

newtab
```




- 







```{r}
?gtrends
```

In this notebook, we want to explore the search interest in crime related topics in Chicago, IL. In order to narrow our API query to a specific region, DMA codes can be used.

https://help.ooyala.com/video-platform/reference/dma_codes.html

The resulting object is of class `gtrends`, for which the `gtrends` package provides a tailored plotting function.

```{r}
shootings <- gtrends(c("Milwaukee shooting", "Grantsville shooting", "El Paso shooting", "Sandy Hook shooting"), geo = "US", time = "2012-01-01 2020-05-07", low_search_volume = T)
plot(shootings)
shootings
```


Information on what is plotted on the y axis can be found here:

https://support.google.com/trends/answer/4365533?hl=en

A quick look at the structure of the `res` object.

```{r}
str(shootings)
```

Seems like the first element of this list is a `data.frame` which holds the main results of the API query.

```{r}
shootings$interest_over_time
```

## tidyr

We will use the `tidyr` package to tidy up this data set. In addition, we will need different piping operators from `magrittr`.

```{r}
# install.packages("tidyverse")
library(tidyverse)
library(magrittr)
```

First, we transform the `data.frame` into a `tibble`.

```{r}
shootings_time <- as_tibble(shootings$interest_over_time)
glimpse(shootings)
```



The resulting object is of class `gtrends`, for which the `gtrends` package provides a tailored plotting function.

```{r}
sandy <- gtrends(c("Sandy Hook shooting"), geo = "US", time = "2012-12-12 2012-12-30", low_search_volume = T)
plot(sandy)
sandy
```


Information on what is plotted on the y axis can be found here:

https://support.google.com/trends/answer/4365533?hl=en

A quick look at the structure of the `res` object.

```{r}
str(sandy)
```



```{r}
sandy$interest_over_time
```

## tidyr

We will use the `tidyr` package to tidy up this data set. In addition, we will need different piping operators from `magrittr`.

```{r}
# install.packages("tidyverse")
library(tidyverse)
library(magrittr)
```

First, we transform the `data.frame` into a `tibble`.

```{r}
sandy_time <- as_tibble(sandy$interest_over_time)
glimpse(sandy)
```

